{% set items = data.sidemenu %}
{% macro sidemenuList(subItems) %}
    {% for item in subItems %}
        <li class="fr-sidemenu__item" data-fr-js-sidemenu-item="true">
            {% if item.children.length > 0 %}
                <button class="fr-sidemenu__btn"
                        aria-expanded="false"
                        aria-controls="{{ item.url }}">{{ item.title }}</button>
                <div class="fr-collapse" id="{{ item.url }}">
                    <ul class="fr-sidemenu__list">
                        {{ sidemenuList(item.children) }}
                    </ul>
                </div>
            {% else %}
                <li class="fr-sidemenu__item" data-fr-js-sidemenu-item="true">
                    <a href="{{ item.url }}"
                                    class="fr-sidemenu__link"
                                    id="sidemenu__link-accordeon-accordion"
                                    target="_self"
                                    data-fr-js-sidemenu-link-actionee="true">
                        {{ item.title }}
                    </a>
                </li>
            {% endif %}
        </li>
    {% endfor %}
{% endmacro %}

<nav
    role="navigation"
    aria-label="Menu latéral"
    class="fr-sidemenu fr-sidemenu--sticky-full-height fr-mb-0-5v"
    data-fr-js-sidemenu-actionee="true">
    <div class="fr-sidemenu__inner fr-pt-12v">
        <button aria-controls="sidemenu-286" aria-expanded="false" class="fr-sidemenu__btn" data-fr-js-collapse-button="true">
            Dans cette rubrique
        </button>
       <div id="sidemenu-286" class="fr-collapse" data-fr-js-collapse="true">
            <ul class="fr-sidemenu__list" data-fr-js-sidemenu-list="true">
                {{ sidemenuList(items) }}
            </ul>
        </div>
    </div>
</nav>

<script>
(() => {
    // trouver le tag "a" correspondant au hash
    const hash = window.location.hash
    const link = document.querySelector(`.fr-sidemenu__link[href='${hash}']`);

    if (link) {
        link.ariaCurrent = "page"

        /**
         * Parcourir les liens du sidemenu, (boucle jusqu'à trouver fr-sidemenu__inner)
         * - si l'élément à la classe fr-collapse (c'est la div qui enrobe la sous-liste actuelle), ajouter sur sur son element précédent (le button) el.previousElementSibling.ariaExpanded = true pour ouvrir le collapse.
         * - Et lui ajouter l'attribut aria-current="true"
         */
        let el = link.parentElement
        do {
            if (el?.classList?.contains("fr-collapse")) {
                el.previousElementSibling.ariaExpanded = true
                el.ariaCurrent = "true"
            }

            el = el.parentElement
        } while (!el?.classList?.contains("fr-sidemenu__inner")); // on est arrivés an haut du sommaire, on a fini la boucle
    }

    const allLinks = document.querySelectorAll("a.fr-sidemenu__link")

    const handleClick = (e) => {
        allLinks.forEach(link => link.ariaCurrent = null)
        e.currentTarget.ariaCurrent = "page"
    }

    allLinks.forEach(link => {
        link.addEventListener("click", handleClick)
    })
})();
</script>
